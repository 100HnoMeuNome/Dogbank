# =====================================================
# DOGBANK FRONTEND - DEPLOYMENT COMPLETO
# =====================================================
# Traefik será instalado separadamente via Helm
# Este arquivo contém apenas: Frontend + Middlewares + IngressRoute
# =====================================================

# ===================== NAMESPACE ======================
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    name: production

---
# ===================== CONFIGMAP NGINX ================
apiVersion: v1
kind: ConfigMap
metadata:
  name: dogbank-frontend-nginx-conf
  namespace: production
data:
  nginx.conf: |-
    server {
      listen 8080;
      server_name _;
      root /usr/share/nginx/html;
      index index.html index.htm;

      location / {
        try_files $uri $uri/ /index.html;
      }

      location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
      }
    }

---
# ===================== DEPLOYMENT FRONTEND ============
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dogbank-frontend
  namespace: production
  labels:
    app: dogbank-frontend
    version: v1.3
spec:
  replicas: 2
  selector:
    matchLabels:
      app: dogbank-frontend
  template:
    metadata:
      labels:
        app: dogbank-frontend
        version: v1.3
    spec:
      containers:
      - name: dogbank-frontend
        image: schawirin/dogbank-frontend:latest
        imagePullPolicy: Always
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        
        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
        
        # Resources
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        # Volume mount para nginx config
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/nginx.conf
          subPath: nginx.conf
      
      volumes:
      - name: nginx-config
        configMap:
          name: dogbank-frontend-nginx-conf

---
# ===================== SERVICE FRONTEND ===============
apiVersion: v1
kind: Service
metadata:
  name: dogbank-frontend-service
  namespace: production
  labels:
    app: dogbank-frontend
spec:
  type: ClusterIP
  selector:
    app: dogbank-frontend
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 8080

---
# ===================== MIDDLEWARE STRIP API ===========
# Remove "/api/<primeiro-segmento>" do path
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-api
  namespace: production
spec:
  stripPrefixRegex:
    regex:
    - "^/api/[^/]+"

---
# ===================== MIDDLEWARE CORS ================
# Permite CORS para desenvolvimento local
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cors-allow-localhost
  namespace: production
spec:
  headers:
    accessControlAllowOriginList:
    - "http://localhost:3000"
    - "http://localhost:8080"
    - "http://dogbank.local"
    accessControlAllowMethods:
    - "GET"
    - "POST"
    - "PUT"
    - "PATCH"
    - "DELETE"
    - "OPTIONS"
    accessControlAllowHeaders:
    - "*"
    accessControlAllowCredentials: true
    accessControlMaxAge: 100
    addVaryHeader: true

---
# ===================== INGRESS ROUTE FRONTEND =========
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: frontend-route
  namespace: production
  labels:
    app: dogbank-frontend
spec:
  entryPoints:
  - web
  routes:
  # Rota principal do frontend (deve ter prioridade MENOR)
  - match: Host(`dogbank.local`) && PathPrefix(`/`)
    kind: Rule
    services:
    - name: dogbank-frontend-service
      port: 80
    priority: 1

---
# ===================== INGRESS ROUTE APIs =============
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: backend-apis-route
  namespace: production
  labels:
    app: dogbank-backend
spec:
  entryPoints:
  - web
  routes:
  # AUTH API
  - match: Host(`dogbank.local`) && PathPrefix(`/api/auth`)
    kind: Rule
    services:
    - name: auth-service
      port: 80
    middlewares:
    - name: strip-api
    - name: cors-allow-localhost
    priority: 100
  
  # ACCOUNTS API
  - match: Host(`dogbank.local`) && PathPrefix(`/api/accounts`)
    kind: Rule
    services:
    - name: accounts-service
      port: 80
    middlewares:
    - name: strip-api
    - name: cors-allow-localhost
    priority: 100
  
  # TRANSACTIONS API
  - match: Host(`dogbank.local`) && PathPrefix(`/api/transactions`)
    kind: Rule
    services:
    - name: transactions-service
      port: 80
    middlewares:
    - name: strip-api
    - name: cors-allow-localhost
    priority: 100
  
  # BANCO CENTRAL API
  - match: Host(`dogbank.local`) && PathPrefix(`/api/bancocentral`)
    kind: Rule
    services:
    - name: bancocentral-service
      port: 80
    middlewares:
    - name: strip-api
    - name: cors-allow-localhost
    priority: 100
  
  # INTEGRATION API
  - match: Host(`dogbank.local`) && PathPrefix(`/api/integration`)
    kind: Rule
    services:
    - name: integration-service
      port: 80
    middlewares:
    - name: strip-api
    - name: cors-allow-localhost
    priority: 100
  
  # NOTIFICATIONS API
  - match: Host(`dogbank.local`) && PathPrefix(`/api/notifications`)
    kind: Rule
    services:
    - name: notifications-service
      port: 80
    middlewares:
    - name: strip-api
    - name: cors-allow-localhost
    priority: 100